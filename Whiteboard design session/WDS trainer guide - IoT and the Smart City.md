![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/master/Media/ms-cloud-workshop.png 'Microsoft Cloud Workshops')

<div class="MCWHeader1">
IoT and the Smart City
</div>

<div class="MCWHeader2">
Whiteboard design session trainer guide
</div>

<div class="MCWHeader3">
June 2020
</div>

Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.

Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.

The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein.

Â© 2020 Microsoft Corporation. All rights reserved.

Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.

**Contents**

<!-- TOC -->

- [Trainer information](#trainer-information)
  - [Role of the trainer](#role-of-the-trainer)
  - [Whiteboard design session flow](#whiteboard-design-session-flow)
  - [Before the whiteboard design session: How to prepare](#before-the-whiteboard-design-session-how-to-prepare)
  - [During the whiteboard design session: Tips for an effective whiteboard design session](#during-the-whiteboard-design-session-tips-for-an-effective-whiteboard-design-session)
- [IoT and the Smart City whiteboard design session student guide](#iot-and-the-smart-city-whiteboard-design-session-student-guide)
  - [Abstract and learning objectives](#abstract-and-learning-objectives)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study)
    - [Customer situation](#customer-situation)
    - [Customer needs](#customer-needs)
    - [Customer objections](#customer-objections)
    - [Infographic for common scenarios](#infographic-for-common-scenarios)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution)
  - [Step 3: Present the solution](#step-3-present-the-solution)
  - [Wrap-up](#wrap-up)
  - [Additional references](#additional-references)
- [IoT and the Smart City whiteboard design session trainer guide](#iot-and-the-smart-city-whiteboard-design-session-trainer-guide)
  - [Step 1: Review the customer case study](#step-1-review-the-customer-case-study-1)
  - [Step 2: Design a proof of concept solution](#step-2-design-a-proof-of-concept-solution-1)
  - [Step 3: Present the solution](#step-3-present-the-solution-1)
  - [Wrap-up](#wrap-up-1)
  - [Preferred target audience](#preferred-target-audience)
  - [Preferred solution](#preferred-solution)
  - [Checklist of preferred objection handling](#checklist-of-preferred-objection-handling)
  - [Customer quote (to be read back to the attendees at the end)](#customer-quote-to-be-read-back-to-the-attendees-at-the-end)

<!-- /TOC -->

# Trainer information

Thank you for taking time to support the whiteboard design sessions as a trainer!

## Role of the trainer

An amazing trainer:

- Creates a safe environment in which learning can take place.

- Stimulates the participant's thinking.

- Involves the participant in the learning process.

- Manages the learning process (on time, on topic, and adjusting to benefit participants).

- Ensures individual participant accountability.

- Ties it all together for the participant.

- Provides insight and experience to the learning process.

- Effectively leads the whiteboard design session discussion.

- Monitors quality and appropriateness of participant deliverables.

- Effectively leads the feedback process.

## Whiteboard design session flow

Each whiteboard design session uses the following flow:

**Step 1: Review the customer case study (15 minutes)**

**Outcome**

Analyze your customer's needs.

- Customer's background, situation, needs and technical requirements

- Current customer infrastructure and architecture

- Potential issues, objectives and blockers

**Step 2: Design a proof of concept solution (60 minutes)**

**Outcome**

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

- Determine your target customer audience.

- Determine customer's business needs to address your solution.

- Design and diagram your solution.

- Prepare to present your solution.

**Step 3: Present the solution (30 minutes)**

**Outcome**

Present solution to your customer:

- Present solution

- Respond to customer objections

- Receive feedback

**Wrap-up (15 minutes)**

- Review preferred solution

## Before the whiteboard design session: How to prepare

Before conducting your first whiteboard design session:

- Read the Student guide (including the case study) and Trainer guide.

- Become familiar with all key points and activities.

- Plan the point you want to stress, which questions you want to drive, transitions, and be ready to answer questions.

- Prior to the whiteboard design session, discuss the case study to pick up more ideas.

- Make notes for later.

## During the whiteboard design session: Tips for an effective whiteboard design session

**Refer to the Trainer guide** to stay on track and observe the timings.

**Do not expect to memorize every detail** of the whiteboard design session.

When participants are doing activities, you can **look ahead to refresh your memory**.

- **Adjust activity and whiteboard design session pace** as needed to allow time for presenting, feedback, and sharing.

- **Add examples, points, and stories** from your own experience. Think about stories you can share that help you make your points clearly and effectively.

- **Consider creating a "parking lot"** to record issues or questions raised that are outside the scope of the whiteboard design session or can be answered later. Decide how you will address these issues, so you can acknowledge them without being derailed by them.

**\*Have fun**! Encourage participants to have fun and share!\*

**Involve your participants.** Talk and share your knowledge but always involve your participants, even while you are the one speaking.

**Ask questions** and get them to share to fully involve your group in the learning process.

**Ask first**, whenever possible. Before launching into a topic, learn your audience's opinions about it and experiences with it. Asking first enables you to assess their level of knowledge and experience, and leaves them more open to what you are presenting.

**Wait for responses**. If you ask a question such as, "What's your experience with (fill in the blank)?" then wait. Do not be afraid of a little silence. If you leap into the silence, your participants will feel you are not serious about involving them and will become passive. Give participants a chance to think, and if no one answers, patiently ask again. You will usually get a response.

# IoT and the Smart City whiteboard design session student guide

## Abstract and learning objectives

This whiteboard design session is designed to help you gain a better understanding of implementing architectures that use IoT data in new and innovative ways. You will design an IoT workflow that begins with a local IoT edge device that collects and analyzes data from various sensors that are connected to it, and intelligently aggregates and sends that data to the cloud when anomalies are detected. Once the data is uploaded, it is sent to a time-series database for rapid analysis alongside other classes of IoT data to spot and act on correlated information in real-time. You will also configure alerts when certain thresholds are exceeded and configure a remote monitoring accelerator solution that manages and sends control messages to IoT devices located within the city limits.

At the end of this whiteboard design session, you will be better able to design an end-to-end IoT solution that processes and analyzes data both in the field and in the cloud.

## Step 1: Review the customer case study

**Outcome**

Analyze your customer's needs.

Timeframe: 15 minutes

Directions: With all participants in the session, the facilitator/SME presents an overview of the customer case study along with technical tips.

1.  Meet your table participants and trainer.

2.  Read all of the directions for steps 1-3 in the student guide.

3.  As a table team, review the following customer case study.

### Customer situation

Fabrikam City council has conducted a six-month study of new and emerging technologies that can improve the lives of its citizens. Being the largest city in the US, the challenges most cities face are compounded by scale. Many of these challenges revolve around city traffic and public transportation.

At the conclusion of their study, the city council realized that the Internet of Things (IoT) is widely available and is becoming more integrated into our daily lives. Fabrikam City can capitalize on the wide availability and affordability of IoT devices. This means physical things like traffic lights and vehicles will be able to collect and share data by connecting to the Internet. Through analytics, cities can turn this data into intelligent information that will change the way the world works.

They realize that IoT offers cities revolutionary ways to gather this vital data. This wave of change will enable innovation, new services, and cost savings. However, if Fabrikam City is going to be \"smart\" (that is, IoT-connected), it needs to devise a strategy for deploying technologies rather than allowing 1,000 ad-hoc systems to take root without forethought. A proactive strategy will maximize the return on an IoT investment.

Fabrikam City buses are widely used throughout the many boroughs, such as Northwind, Contoso, and Tailwind. It would make sense to somehow attach IoT devices to those buses to perform a number of functions such as preventive maintenance and tracking driver performance. It would be great if only the most important information is sent off over the internet instead of constantly sending a lot of data over expensive cellular connectivity. The most important information could be described as anomalies, like impending mechanical breakdowns or reckless driving. The buses will periodically send their location information that can be used to track their progress on their route. All of the information can be uploaded once the bus arrives at its home station where it has Wi-Fi connectivity. The full data could then be used for accounting and analysis of the data collected throughout the day.

In regard to traffic lights, Fabrikam city council would also like reduce physical inspections by adding IoT devices with sensors that can detect maintenance and performance issues, such as if the light sequence is stuck in a continuous cycle loop outside of normal parameters, voltage irregularities, etc. Unlike the city buses, these traffic lights are always connected to the internet and can send and receive command and control information as often as needed.

Relecloud has been contracted to build a cloud-based architecture based on these requirements. They have researched IoT-related service offerings from various cloud providers and are interested in recent capabilities added to Azure for storing and evaluating time series data, as well as building IoT devices that run on the edge for localized data transformation and processing.

"While bidding for the Fabrikam smart city contract, we made it a primary goal from the start to build a solution that can easily be taken over by the city's IT department," says Rodrigo Romani, CTO of Relecloud. "Localizing telemetry captured on buses, that can be evaluated on the fly, while at the same time controlling the flow of data over a slow or unreliable internet connection seems like a tall order. We need a solution that is repeatable for fleets of buses entering or leaving service and is manageable in a way that makes it easy to send out targeted updates to groups of buses at a time."

Following this same mandate of ease of use and future flexibility without overtaxing an already busy city IT department, Relecloud is seeking options for capturing and displaying time series data that allows the end user to easily combine all of the data in any number of ways, with advanced querying and filtering options, and that can automatically handle schema changes of incoming telemetry and new device types as they are added. Additionally, this data needs to be accessible by an external web application for managing alerts and device management and must be able to display the raw data within a given timeframe, without pre-aggregation, at scale.

### Customer needs

1.  Reduce bus maintenance costs by analyzing city bus telemetry and applying predictive analysis provided by a trained machine learning model.

2.  Detect other anomalies, such as bus driver behavior, that can be sent as needed.

3.  Reduce the amount of information transmitted to the cloud by buses, which use expensive cellular data.

4.  Store the bus telemetry data locally when offline and send when internet connectivity is available.

5.  Send regular location updates of city buses that can be used to display on a map and update bus route status.

6.  Install IoT devices on traffic lights for maintenance purposes.

7.  Easily combine all of the time series data in a single pane of view, with advanced querying and filtering options, and that can automatically handle schema changes of incoming telemetry and new device types as they are added.

8.  Have a web portal to view the buses and traffic lights on a map, manage device provisioning, alert rules, reference data, and control messages.

### Customer objections

1.  If bus data is collected offline and sent later on, how can we be certain that the time series data is not displayed out of order from when it was captured?

2.  We would like to be able to have more than one service access the IoT data without leading to reuse by multiple readers, and other negative effects. Is this possible?

3.  We are concerned about rolling out updates to all edge devices at once, in case there's a problem. Can we deploy updates to small groups instead?

### Infographic for common scenarios

![A Common Scenario of Internet of Things flowchart is split between Azure and On-Premises. At a high level, Azure steps are: Ingest, Stream Processing, Batch Storage, Speed Serving, Batch Processing, Batch View Serving, and Analytics Clients.](images/Whiteboarddesignsessionstudentguide-IoTandtheSmartCityimages/media/image2.png 'Common Scenario for IoT')

## Step 2: Design a proof of concept solution

**Outcome**

Design a solution and prepare to present the solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 60 minutes

**Business needs**

Directions: With all participants at your table, answer the following questions and list the answers on a flip chart:

1.  Who should you present this solution to? Who is your target customer audience? Who are the decision makers?

2.  What customer business needs do you need to address with your solution?

**Design**

Directions: With all participants at your table, respond to the following questions on a flip chart:

_High-level architecture_

1.  Without getting into the details (the following sections will address the particular details), diagram your initial vision for handling the top-level requirements for the bus and traffic light IoT devices, data ingestion, storage, and visualization.

_IoT Devices_

1.  Which data ingest service would you use for this scenario, IoT Hub or Event Hubs? Be specific.

2.  How will you process the vehicle telemetry data locally to only send important data about driver performance or potential mechanical issues while the bus is in transit, with limited data connectivity?

3.  What would you recommend using to separately send bus location and speed data at regular intervals?

4.  Describe how you would send traffic light telemetry, and in turn, have the traffic lights receive commands to update their timing.

5.  Using your ingest service, how would you handle critical messages separately to route them to custom endpoints based on message properties?

_Data and visualization_

1.  Keeping the requirement for ease of use and flexibility in mind, how would you propose storing time series data for all the IoT devices? Is there a need for secondary storage?

2.  How will you allow end users to visualize the large amount of data in one place, which is flexible enough to handle changing data schemas and allow for ad-hoc queries and sharing views between users?

3.  Describe how the custom web application will be hosted, as well as how it will access the stored telemetry including displaying location information on a map, manage reference data (speed limit information, speed alert thresholds, vehicle information, etc.), alerts, and device control messages. Also, describe how you will use it to provision new IoT devices and send manual cloud-to-device messages.

4.  What would you recommend using to combine bus and traffic light information, filtering the data by the close proximity of both types of IoT devices, then by average bus speed information based on predefined speed thresholds?

_Location-based data and mapping_

1.  Relecloud wants to integrate map visualization to show the location of buses, traffic lights, and other devices. They would like to use a mapping service that does not require them to send data to an external resource, can be used with other Azure services like Stream Analytics, and supports data privacy and compliance when needed.

**Prepare**

Directions: With all participants at your table:

1.  Identify any customer needs that are not addressed with the proposed solution.

2.  Identify the benefits of your solution.

3.  Determine how you will respond to the customer's objections.

Prepare a 15-minute chalk-talk style presentation to the customer.

## Step 3: Present the solution

**Outcome**

Present a solution to the target customer audience in a 15-minute chalk-talk format.

Timeframe: 30 minutes

**Presentation**

Directions:

1.  Pair with another table.

2.  One table is the Microsoft team and the other table is the customer.

3.  The Microsoft team presents their proposed solution to the customer.

4.  The customer makes one of the objections from the list of objections.

5.  The Microsoft team responds to the objection.

6.  The customer team gives feedback to the Microsoft team.

7.  Tables switch roles and repeat Steps 2-6.

## Wrap-up

Timeframe: 15 minutes

Directions: Tables reconvene with the larger group to hear the facilitator/SME share the preferred solution for the case study.

## Additional references

|                                                                          |                                                                                                 |
| ------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------: |
| Hi-resolution version of blueprint                                       |                     <https://msdn.microsoft.com/dn630664#fbid=rVymR_3WSRo>                      |
| What is Azure IoT Edge?                                                  |              <https://docs.microsoft.com/en-us/azure/iot-edge/how-iot-edge-works>               |
| Understand the requirements and tools for developing IoT Edge modules    |              <https://docs.microsoft.com/en-us/azure/iot-edge/module-development>               |
| Deploy Azure Machine Learning as an IoT Edge module                      |       <https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-deploy-machine-learning>        |
| Deploy and monitor IoT Edge modules at scale                             |             <https://docs.microsoft.com/en-us/azure/iot-edge/how-to-deploy-monitor>             |
| Understand and use device twins in IoT Hub                               |         <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-device-twins>          |
| Routing messages with IoT Hub                                            |       <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-csharp-csharp-process-d2c>        |
| Use message routes and custom endpoints for device-to-cloud messages     |     <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-read-custom>      |
| Send cloud-to-device messages from IoT Hub                               |         <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-c2d>          |
| Schedule jobs on multiple devices                                        |             <https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-jobs>              |
| What is Azure Time Series Insights?                                      |   <https://docs.microsoft.com/en-us/azure/time-series-insights/time-series-insights-overview>   |
| Azure Time Series Insights explorer                                      |   <https://docs.microsoft.com/en-us/azure/time-series-insights/time-series-insights-explorer>   |
| About Azure Cosmos DB                                                    |                 <https://docs.microsoft.com/en-us/azure/cosmos-db/introduction>                 |
| Target Azure Cosmos DB for JSON output from Stream Analytics             |  <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-documentdb-output>   |
| Using reference data or lookup tables in a Stream Analytics input stream |  <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-use-reference-data>  |
| Run Azure Functions with Azure Stream Analytics jobs                     | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-with-azure-functions> |
| Azure Stream Analytics on IoT Edge                                       |         <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-edge>         |
| GeoSpatial Functions                                                     |                    <https://msdn.microsoft.com/en-us/library/mt778980.aspx>                     |
| About Azure Location Based Services                                      | <https://docs.microsoft.com/en-us/azure/location-based-services/about-location-based-services>  |
| Using the Azure Location Based Services Search service                   |   <https://docs.microsoft.com/en-us/azure/location-based-services/how-to-search-for-address>    |


# IoT and the Smart City whiteboard design session trainer guide

## Step 1: Review the customer case study

- Check in with your table participants to introduce yourself as the trainer.

- Ask, "What questions do you have about the customer case study?"

- Briefly review the steps and timeframes of the whiteboard design session.

- Ready, set, go! Let the table participants begin.

## Step 2: Design a proof of concept solution

- Check in with your tables to ensure that they are transitioning from step to step on time.

- Provide some feedback on their responses to the business needs and design.

  - Try asking questions first that will lead the participants to discover the answers on their own.

- Provide feedback for their responses to the customer's objections.

  - Try asking questions first that will lead the participants to discover the answers on their own.

## Step 3: Present the solution

- Determine which table will be paired with your table before Step 3 begins.

- For the first round, assign one table as the presenting team and the other table as the customer.

- Have the presenting team present their solution to the customer team.

  - Have the customer team provide one objection for the presenting team to respond to.

  - The presentation, objections, and feedback should take no longer than 15 minutes.

  - If needed, the trainer may also provide feedback.

## Wrap-up

- Have the table participants reconvene with the larger session group to hear the facilitator/SME share the following preferred solution.

## Preferred target audience

Rodrigo Romani, Chief Technical Officer (CTO), Relecloud

The primary audience is the business decision makers and technology decision makers. From the case study scenario, this includes Rodrigo Romani, CTO of Relecloud. Usually we talk to the infrastructure managers who report to the chief information officers (CIOs), or to application sponsors (like a vice president \[VP\] line of business \[LOB\], or chief marketing officer \[CMO\]), or to those who represent the business unit IT or developers that report to application sponsors.

## Preferred solution

_High-level architecture_

1.  Without getting into the details (the following sections will address the particular details), diagram your initial vision for handling the top-level requirements for the IoT Smart City.

    ![The Solution Architecture diagram is described in the text following the diagram.](images/Whiteboarddesignsessiontrainerguide-IoTandtheSmartCityimages/media/image3.png 'Solution Architecture diagram')

    The solution begins with an IoT Edge device installed on each city bus, which is responsible for reading the vehicle telemetry from the bus, such as speed, fuel level, oil level, engine temperature, etc. A trained Azure Machine Learning model is used in the vehicle telemetry module on the IoT Edge device to detect driver anomalies. An Azure Stream Analytics module is added to the IoT Edge device to filter the output of the vehicle telemetry module and send only the anomaly data to IoT Hub. A GPS IoT device is separately added to the bus to periodically send location and speed data to IoT Hub. An IoT device is added to various traffic lights to send maintenance-related telemetry, such as voltage readings and timing. It is registered as a device in IoT Hub, including properties such as its longitude and latitude and serial number. It can receive cloud-to-device messages through IoT Hub, allowing upstream services to send updates like the timing of its lights. An additional consumer group is added to IoT Hubs messages/events endpoint, allowing a Time Series Insights instance and a Stream Analytics instance to simultaneously read the incoming data. Time Series Insights is used to store the raw time series data and provides advanced filtering, custom ad-hoc queries, and visualizations that can overlay data from several classes of IoT devices. Stream Analytics is used to collect the bus GPS and traffic light data. Cloud-to-device control message can be queued from the Web Application to the IoT Hub to send a timing change request to a specific traffic light if needed. Time Series Insights displays a custom view of the captured IoT data. The remote accelerator solution web application plots the devices on a map. The web app connects to Cosmos DB to manage alert rules and device control messages. It is also used to provision new IoT devices and send manual cloud-to-device messages through IoT Hub. 

> **Note**: The preferred solution is only one of many possible, viable approaches.

_IoT Devices_

1.  Which data ingest service would you use for this scenario, IoT Hub or Event Hubs? Be specific.

    Use IoT Hub to manage the devices and ingest all data. Unlike Event Hubs, it enables two-way communication between Azure and the devices, allowing the customer to send control data back to devices as needed, as well as remotely managing firmware updates. In addition, IoT Hub enables you to use and manage IoT Edge devices, which will be used on the buses.

2.  How will you process the vehicle telemetry data locally to only send important data about driver performance or potential mechanical issues while the bus is in transit, with limited data connectivity?

    Azure IoT Edge can be used to shift the data analytics responsibility from the cloud to each bus, and only send that data up to Azure when an anomaly is detected. This helps dramatically cut down on the amount of data that needs to be sent out, meeting their requirement for minimizing cellular data usage. Create an IoT Edge device with a custom module to ingest the vehicle telemetry. Use a trained ML.NET model that evaluates the vehicle telemetry and determines driver performance irregularities locally. Add a Stream Analytics module that filters the output of the vehicle telemetry module and send only the anomaly data to IoT Hub. Routes are used to allow modules to send data to each other, then send the final filtered data upstream to IoT Hub. All data is stored locally while offline and can be sent when internet connectivity is available using the Azure Blob Storage on Edge module.

3.  What would you recommend using to separately send bus location and speed data at regular intervals?

    A GPS-enabled IoT device can be added to the bus that regularly sends bus location through IoT Hub. This data will be used to update bus route information.

4.  Describe how you would send traffic light telemetry, and in turn, have the traffic lights receive commands to update their timing.

    Traffic lights will have IoT devices installed that send maintenance-related telemetry, such as voltage readings, timing, etc. When the IoT device is provisioned in IoT Hub, its device twin will contain metadata properties for the serial number, latitude, and longitude information. The custom web application will populate this data and handle device provisioning for this and other IoT devices. The device will update its reported properties for its maintenance and state telemetry through device-to-cloud messages. One-way notifications can be sent to the device via cloud-to-device messages sent through IoT Hub that can be used to modify the light timing (how long a light stays green or red). In addition, the back-end service that sends the cloud-to-device message can request feedback from the device, letting it know whether the command was successfully processed. This allows the sender to implement retry or compensation logic.

5.  Using your ingest service, how would you handle critical messages separately to route them to custom endpoints based on message properties?

    Use custom endpoints and routes in IoT Hub to route device-to-cloud messages to a service-facing endpoint such as a Service Bus Queue, based on the message property. This will make sure critical messages, such as a traffic light outage or mechanical failure on a bus, to be processed separately if needed. This is accomplished by creating a new Service Bus Queue in the same subscription and region as IoT Hub, then creating a custom endpoint in IoT Hub that for the queue. Create a new route using DeviceMessages as its data source, the custom endpoint you created for the route endpoint, and a query parameter that filters on a device property, such as: level="critical". Device messages flowing into IoT Hub that meet the new routing rule will be sent to your Service Bus Queue, where any downstream services or applications can act upon the message data.

_Data and visualization_

1.  Keeping the requirement for ease of use and flexibility in mind, how would you propose storing time series data for all the IoT devices? Is there need for secondary storage?

    Use Azure Time Series Insights to store, visualize, and query the large amounts of time series data generated by the edge and traffic light IoT devices, as well as conduct root-cause analysis and anomaly detection. It easily connects to IoT Hub and automatically parsons JSON from messages and joins metadata with telemetry and indexes your data in a columnar store. This data is stored long-term, and you can interactively query billions of events in seconds. Time series data is defined by data that has a timestamp, and time is most meaningful as an axis. Because we are tracking buses, traffic lights, and potentially other smart devices that have the potential of interacting with one another, being able to view this related information side-by-side or over top of one another is useful for correlating events that occur at the same time. Time Series Insights has tools like patterns and perspective views to conduct and save multi-step root-cause analysis. Further, Time Series Insights works in conjunction with alerting services like Azure Stream Analytics, so alerts and detected anomalies can be viewed in near real-time in the Time Series Insights explorer. As for secondary storage, yes, a data store such as Cosmos DB can be used to store data that relates to incoming device telemetry that is stored in Time Series Insights. This includes alert information that is generated when maintenance issues occur, and alert settings for specifying alert thresholds such as average bus speed ranges in proximity to traffic lights that could indicated congestion requiring traffic light timing updates. Additionally, bus location data can be ingested into Cosmos DB to be used as a reference when comparing current speed and location information to help detect traffic congestion, as well as to update bus route data. This database can also be used to help manage IoT devices, store data that is used when rolling out firmware updates, etc.

2.  How will you allow end users to visualize the large amount of data in one place, which is flexible enough to handle changing data schemas and allow for ad-hoc queries and sharing views between users?

    Time Series Insights (TSI) provides high-performance visualizations out of the box to help users overlay device telemetry as well as associated events from alerting services like Stream Analytics. Use its perspective view to quickly clone, modify existing visualizations, and add additional ones in a quad-chart view. All visualizations can be saved and shared with other users in your organization. The flexible query and filtering interface helps users rapidly adapt to changing schemas and new device types. There is no need to construct custom forms that contain fields for device-specific schemas, as all of this is dynamically handled by the Time Series Insights interface. TSI makes it easy to view the raw message data for any given timeframe and device.

3.  Describe how the custom web application will be hosted, as well as how it will access the stored telemetry including displaying location information on a map, manage reference data (speed limit information, speed alert thresholds, vehicle information, etc.), alerts, and device control messages. Also, describe how you will use it to provision new IoT devices and send manual cloud-to-device messages.

    Host the Azure Remote Monitoring accelerator web application in the Web Apps PaaS service. Alternatively, host it within a series of Docker containers in a microservices architecture for maximum scalability if needed. The web application can use Time Series Insights as its back-end service for indexing, storing, and aggregating time series data. This is where any custom visualizations, such as dynamic maps can be built and served to display the data. It will connect to Cosmos DB, the secondary data store in this scenario, to access and store reference data. Using the Remote Monitoring web application, define alert thresholds and device control message schema information that will be used to either manually send cloud-to-device messages from the web app, or automatically from another service such as Azure Functions. Use the same Remote Monitoring Accelerator web app to simplify device management and initiate jobs, such as updating device properties or tags, or invoking direct methods on multiple (potentially millions) of devices.

4.  What would you recommend using to combine bus and traffic light geolocation information, to rate incoming telemetry vs predefined thresholds so that a cloud to device message commanding job may be sent to a traffic light?

    The remote monitoring accelerator provides a map that automatically plots device location based on their latitude and longitude reported properties. The web application also allows for the definition of threshold rules where it will automatically evaluate incoming telemetry and initiating an alert. Users of the web application have the opportunity to review the alerts and to queue a device to cloud message job to control the timing of traffic lights.

_Location-based data and mapping_

1.  Relecloud wants to integrate map visualization to show the location of buses, traffic lights, and other devices. They would like to use a mapping service that does not require them to send data to an external resource, can be used with other Azure services like Stream Analytics, and supports data privacy and compliance when needed.

    The remote monitoring accelerator uses the Azure Maps Services to render its map. This allows all of the data to stay within Azure and removes an external dependency, allowing the customer to use the same billing, account, and Azure infrastructure as all of the other services in this solution. As a first-class service, LBS supports data privacy and compliance, such as GDPR (General Data Protection Regulation).


## Checklist of preferred objection handling

1.  If bus data is collected offline and sent later on, how can we be certain that the time series data is not displayed out of order from when it was captured?

    When you are collecting and storing time series data, the order of events and accurate time stamping is crucial. Configure Time Series Insights to use the vehicle telemetry timestamp to order the data. This ensures that data received out of order, or sometime in the future long after the event occurred, is accurately reflected in its actual time of event.

2.  We would like to be able to have more than one service access the IoT data without leading to reuse by multiple readers, and other negative effects. Is this possible?

    Yes, this is possible by adding additional event consumers to the IoT Hub messaging endpoint. You can also add up to 10 custom endpoints used to send messages to different services based on routing rules.

3.  We are concerned about rolling out updates to all edge devices at once, in case there's a problem. Can we deploy updates to small groups instead?

    Yes, this can be accomplished by creating an IoT Edge deployment. This is a dynamic process that enables you to deploy multiple modules to multiple edge devices at once and track the status and health of the modules. Your devices need one or more tags configured in the device twin that can be used to group updates to similar devices. For instance, you might have various fleets of buses that you can identify as fleet1, fleet2, etc. All buses in fleet1 can be updated at once, in this case.

## Customer quote (to be read back to the attendees at the end)

"We were amazed when our Microsoft rep introduced us to IoT Edge devices! We were already familiar with IoT Hub, Streaming Analytics, and Azure Machine Learning, but when we found out that some of these same components can be run on a modestly powered device on our buses through IoT Edge, we couldn't wait to get started. The best part about our new solution is that we were able to use the same powerful capabilities for working with our IoT devices both offline and in the cloud. Having ready-made services online in minutes that help us handle, and manage, a huge number of devices was just the cherry on top!"

--- Rodrigo Romani, CTO, Relecloud
