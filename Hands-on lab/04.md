## Exercise 4: Create IoT Edge device and custom modules

**Duration:** 60 minutes

Azure IoT Edge devices can run on in locations where there is little to no internet connectivity, yet they allow you to run powerful modules locally, enabling you to apply your business logic in place. This is especially powerful when coupled with sensors that generate a lot of data, and you only want to send the most important data to the cloud.

In this scenario, IoT Edge devices will be installed on city buses. You will create a Stream Analytics module to filter the vehicle telemetry data from simulated sensors located within a custom module that you will also build and deploy. When the Stream Analytics module finds behavior consistent with aggressive driving or impending engine failure, the data will be sent to Azure via IoT Hub. The obvious benefit to this is that the massive amount of data can be analyzed locally, and only the important data is sent over the expensive cellular data connection. All data is also stored on the Edge Device itself and is uploaded automatically via Blob Storage channels in the cloud once sufficient connectivity is established.

### Help references

|                                                                       |                                                                                 |
| --------------------------------------------------------------------- | :-----------------------------------------------------------------------------: |
| **Description**                                                       |                                    **Links**                                    |
| What is Azure IoT Edge?                                               |      <https://docs.microsoft.com/en-us/azure/iot-edge/how-iot-edge-works>       |
| Understand the requirements and tools for developing IoT Edge modules |      <https://docs.microsoft.com/en-us/azure/iot-edge/module-development>       |
| Develop and deploy a C\# IoT Edge module to your simulated device     |    <https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-csharp-module>     |
| Azure Stream Analytics on IoT Edge                                    | <https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-edge> |
| Azure Blob Storage on IoT Edge | <https://docs.microsoft.com/en-us/azure/iot-edge/how-to-store-data-blob> |

### Task 1: Add a new IoT Edge device

1. Navigate to the Azure Management portal, ``` http://portal.azure.com```.

2. Open **IoT Hub** in your solution's resource group.

3. Select **IoT Edge** from the left-hand menu, then select **+ Add to IoT Edge Device**.

    ![The Add IoT Edge Device button is selected in the IoT Hub blade.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image78.png 'IoT Hub blade')

4. On the Add Device blade, specify the following configuration options:

    a. **Device ID**: bus1

    b. Make sure the Symmetric Key **Authentication Type** is selected, and **Auto Generate Keys** is checked.

    c. **Connect device to IoT Hub** should be Enabled.

    ![In the Add Device blade, fields are set to the previously defined settings.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image79.png 'Add Device blade')

5. Select **Save**.

6. Select your new IoT Edge device from the list of devices.

7. Copy the value for **Connection string--primary key** and save it. This will be used to configure the IoT Edge runtime.

    ![In the Device Details blade, the copy button for the Connection string - primary key is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image80.png 'Device Details blade')

8. Open the device twin properties by pressing the **Device twin** button.

    ![In the Device Details blade, the the Device twin button is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image213.png 'Device Details blade')

9. Set the device twin desired properties to the following, then press **Save**:

    ```javascript
      "Protocol": "MQTT",
      "SupportedMethods": "",
      "Telemetry": {
        "bus-edge;v1": {
          "MessageSchema": {
            "Name": "bus-edge;v1",
            "Format": "JSON",
            "Fields": {
              "abs": "Integer",
              "accelerator_pedal_position": "Integer",
              "agressiveDriving": "Integer",
              "averageEngineTemperature": "Double",
              "averageSpeed": "Double",
              "brake_pedal_status": "Integer",
              "engineoil": "Integer",
              "enginetempanomaly": "Integer",
              "engineTemperature": "Integer",
              "fuel": "Integer",
              "headlamp_status": "Integer",
              "ignitionStatus": "Integer",
              "iothubConnectionModuleId": "Text",
              "odometer": "Integer",
              "oilanomaly": "Integer",
              "outsideTemperature": "Temperature",
              "parking_brake_status": "Integer",
              "speed": "Integer",
              "timestamp": "Text",
              "tirepressure": "Integer",
              "transmission_gear_position": "Text",
              "vin": "Text",
              "windshield_wiper_status": "Integer",
              "mlDetectedAggressiveDriving": "Integer"
            }
          }
        }
      },
      "Type": "Bus",
      "VIN": "Y3J9PV9TN36A4DUB9",
      "Borough": "Northwind",
      "Latitude": 40.70884,
      "Longitude": -74.01456,
    ```

    ![In the Device Twin blade, the desired properties value is set to the code snippet above and the save button is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image214.png 'Device Twin Blade')

### Task 2: Provision new Linux virtual machine to run as the IoT Edge device

In this task, you will provision a new Linux virtual machine that will be used to run the IoT Edge device, using an Azure IoT Edge on Ubuntu virtual machine available from the Azure Marketplace.

1. Open the following URL in a new browser window: ``` https://azuremarketplace.microsoft.com/en-us/marketplace/apps/microsoft_iot_edge.iot_edge_vm_ubuntu?tab=overview ```.

2. Log in with the same Azure account you are currently using.

3. Press the **GET IT NOW** button, then **Continue** to open the deployment template in the Azure Portal.

    ![In the Marketplace web page for Azure IoT Edge on Ubuntu, press the GET IT NOW button.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image200.png 'Azure Marketplace')

4. In the Azure portal press the **Create** button to initiate the provisioning.

5. Complete the quickstart template form with the following parameters:

    a. **Subscription**: Select the same subscription you've been using for the lab.

    b. **Resource group**: Select the same resource group you've been using.

    c. **Virtual Machine Name**: IoTEdgeVM

    c. **Region**: Should be the same as the location of your resource group and other services.

    d. **Image**: Select **Ubuntu Server 16.04 LTS + Azure IoT Edge runtime**

    e. **Size**: **Standard B1ms** is sufficient for this exercise.

    ![The Ubuntu Virtual Machine Settings form is displayed populated with the previous values.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image201.png 'Create a Virtual Machine Blade')

    f. **Authentication**: Select **Password**.

    g. **Admin Username**: **Make note of the username you enter** so you can use it later.

    h. **Admin Password**: **Make note of the password you enter** so you can use it later.

    i. **Public inbound ports**: Select **Allow selected ports**.

    j. **Select inbound ports**: Select **SSH (22)**.

    ![A continuation of Ubuntu Virtual Machine Settings form populated with the previous values.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image202.png 'Create a Virtual Machine Blade')

6. Then select **Review + create**, then after validation passes, press the **Create** button to deploy the Virtual Machine.

7. Once created, access the VMs overview blade, select **Connect**. Copy the SSH command.

    ![The ssh command is highlighted, and the Connect button is selected in the Virtual machine blade.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image82.png 'Virtual machine blade')

8. Open your Bash client and paste the SSH command, then press **Enter**.

    > **Note**: If your SSH command includes a `-i <private key path>` flag, you may optionally remove it from the command when connecting to the virtual machine.

9. When asked whether you want to continue connecting, enter **yes**.

10. Enter the password you provided when provisioned the IoT Remote Monitoring solution.

    ![In the Bash window, the SSH command and the Yes response are both called out.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image83.png 'Bash window')

11. Enter the following command to update the container device connection string (replace value with the **IoT Hub connection string** you copied in Task 1 above):

    ```bash
    sudo /etc/iotedge/configedge.sh "{IoT Hub -> IoT Edge device connection string}"
    ```

12. Execute the following Docker command to see that the IoT Edge agent is running as a module:

    ```bash
    sudo iotedge list
    ```

    ![The Bash window displays with the previous docker command.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image85.png 'Bash window')

    > If you do not see this module right away, re-run the `sudo iotedge list` command after a few seconds.

13. Next, we'll navigate to the root directory. Execute the following commands:

    ```bash
    cd ..
    cd ..
    ```

14. Next, we will create a folder to house the data for our local storage. 

    ```bash
    sudo mkdir storage
    cd storage
    sudo mkdir containerdata
    cd ..
    ```

15. Grant the default module user privileges to the directory by executing the following commands:

    ```bash
    sudo chown -R 11000:11000 /storage/containerdata
    sudo chmod -R 700 /storage/containerdata
    ```

### Task 3: Create and upload the custom C\# IoT Edge module for vehicle telemetry

In this task, you will use Visual Studio Code to complete the custom C\# IoT Edge module that simulates vehicle telemetry representing bus sensor data. Then you will create the Docker container, and register it in your Container Registry instance so it can be deployed to the IoT Edge device.

This simulator accomplishes many things. As part of the project, Fabrikam city wanted to apply machine learning to determine if a bus driver is driving dangerously. A machine learning model has been supplied in this project and is used to determine the safety of the driver by evaluating the current bus speed, with the location (latitude and longitude) of the bus. The prediction from this model is populated in the telemetry data so that it can be used for future processing.

Additionally, all telemetry obtained from the bus sensors is saved in local blob storage. The storage module is responsible for automatically uploading this data to the cloud when a feasible internet connection is established.

1. Open Visual Studio Code.

2. Select **File Open Folder**...

    ![File/Open Folder is selected in the Visual Studio Code window.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image86.png 'Visual Studio Code window')

3. Browse to the lab-files in the Hands-on lab folder. Select the **VehicleTelemetrySimulator** folder.

4. You may see one or more errors about unresolved dependencies or needing to add build and debug assets. Dismiss these messages, as they are not pertinent to the IoT Edge module project.

    ![In the Visual Studio Code window, pop up messages are displayed, the Don't ask again and Close buttons are called out.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image87.png 'Visual Studio Code window')

5. Open **Program.cs** under the **modules** folder.

    ![In the Explorer window, the modules folder is open and Program.cs is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/imageModuleProgramcs.png 'Explorer window')

6. Complete the code for TODO items 1-18.

    a. The first item to complete is to add the device connection string.

    ```C#
     //TODO: 1 - set device connection string for the device client
    //static string _deviceConnectionString = "<device connection string goes here>";
    ```

    b. Set the connection string to the local IoT Edge Blob storage.

    ```C#
    //TODO: 2 - set the connection string for local blob storage
    //static string _storageConnectionString = "DefaultEndpointsProtocol=http;BlobEndpoint=http://azureblobstorageoniotedge:11002/edgestorage;AccountName=edgestorage;AccountKey=pM8cWFj0L8h+VKRfE8Fy3tVVtdfOR4bCIzX8N/sDiK1X0znhu8iatFwVfjzwjedDKe5ln+2cI7wpy+2eO1vvQQ==";
    ```

    c. Create the module client by un-commenting the following line of code. The Module Client is initialized using the device connection string that we initialized our Edge VM with.

    ```C#
    // TODO: 3 - Create module client from container environment variable
    // _vehicleTelemetryModuleClient = await ModuleClient.CreateFromEnvironmentAsync(TransportType.Mqtt);
    ```

   d. Create the device client by un-commenting the following two lines of code. The device client is responsible for retrieving the desired properties from the device twin in the cloud, as well as sending reported properties to the device twin. The values that will be reported are the Latitude, Longitude, and Borough values. The second line of code hooks up a call back method that is called on the device once a desired property has been changed in the Device Twin in the cloud.

   ```C#
    // TODO: 4 - Create device client to obtain desired properties from Twin and update reported properties
    // _deviceClient = DeviceClient.CreateFromConnectionString(_deviceConnectionString);
    // await _deviceClient.SetDesiredPropertyUpdateCallbackAsync(onDesiredPropertiesUpdateAsync, null);
   ```

   e. Use the device client to retrieve the desired properties from the Device Twin in the cloud. Use these values to populate the initial state of the current device.

   ```C#
   // TODO: 5 - initialize device instance with values obtained from the device twin desired properties
    // var twin = await _deviceClient.GetTwinAsync();
    // var desired = twin.Properties.Desired;
    // await UpdateDeviceInstanceFromDesiredProperties(desired);
   ```

    f. Initialize local edge blob storage.

    ```C#
    // TODO: 6 - initialize iot edge storage
        // _storageAccount = CloudStorageAccount.Parse(_storageConnectionString);
        // _blobClient = _storageAccount.CreateCloudBlobClient();
        // _blobContainer = _blobClient.GetContainerReference("telemetry");
        // if(!_blobContainer.Exists()){
        //     _blobContainer.CreateIfNotExists();
        // }
    ```

    g. Populate the current 'state' field values from the retrieved Desired Properties obtain from the Device Twin.

    ```C#
    if (desired["VIN"] != null)
    {
        // TODO: 7 - Set the vin to the value in the device twin
        // _vin = desired["VIN"];
    }
    if (desired["Borough"] != null)
    {
        // TODO: 8 - Set the borough to the value in the device twin
        // _borough = desired["Borough"];
    }

    if (desired["Latitude"] != null)
    {
        // TODO: 9 - Set the latitude to the value in the device twin
        // _latitude = Convert.ToSingle(desired["Latitude"]);
    }
    if (desired["Longitude"] != null)
    {
        // TODO: 10 - Set the longitude to the value in the device twin
        // _longitude = Convert.ToSingle(desired["Longitude"]);
    }
    ```

    h. Initialize a timer to send reported properties to the Device Twin at regular intervals.

    ```C#
        // TODO: 11 - update reported properties at a specified time interval
        // _timer = new Timer(UpdateReportedProperties, null, TimeSpan.FromSeconds(_secondsToTwinReportedPropertiesUpdate), TimeSpan.FromSeconds(_secondsToTwinReportedPropertiesUpdate));
    ```

    i. Implement the code that sends the current state of the device to the cloud through reported properties of the device twin.

    ```C#
        // TODO: 12 - update reported properties with the IoT Hub with most recent Lat/Long
        //patch the changed properties (Latitude, Longitude, Borough)
        // TwinCollection patch = new TwinCollection();
        // patch["Latitude"] = _latitude;
        // patch["Longitude"] = _longitude;
        // patch["Borough"] = _borough;
        // patch["Telemetry"] = _telemetryDefn;
        // Task.Run(async () => await _deviceClient.UpdateReportedPropertiesAsync(patch));
    ```

    j. Initialize the machine learning context, load its model, and create an instance of the prediction engine to evaluate the incoming telemetry for dangerous driving.

    ```C#
        // TODO: 13 - Initialize machine learning prediction model infrastructure
        // var mlContext = new MLContext();
        // ITransformer mlModel = mlContext.Model.Load("BusMlModel/MLModel.zip", out var modelInputSchema);
        // var predEngine = mlContext.Model.CreatePredictionEngine<ModelInput, ModelOutput>(mlModel);
    ```

    k. Populate the input model with the current state data of the bus. This information will be used by the prediction engine to determine if the bus driver is driving dangerously.

    ```C#
        // TODO 14: Create input for the machine learning prediction engine by setting the
        //         device current latitude, longitude, and speed limit
        // var mlInput = new ModelInput()
        // {
        //    Latitude = currRouteData.Latitude,
        //    Longitude = currRouteData.Longitude,
        //    BusSpeed = currRouteData.BusSpeed
        // };
    ```

    l. Use the prediction engine to determine if the driver is driving dangerously.

    ```C#
        // TODO 15: Use this input model to have the prediction engine determine if the
        //          current speed for the device is safe for the latitude and longitude location
        // var mlOutput = predEngine.Predict(mlInput);
    ```

    m. Populate the predicted value into the telemetry being sent by the module.

    ```C#
        // TODO: 16 Populate the machine learning prediction into the telemetry data for upstream systems
        // mlDetectedAggressiveDriving = mlOutput.Prediction
    ```

    n. Output the generated telemetry from the module asynchronously.

    ```C#
        // TODO: 17 - Have the ModuleClient send the event message asynchronously, using the specified output name
        // await _vehicleTelemetryModuleClient.SendEventAsync(outputName, message);
    ```

    o. Save all data to local blob storage

    ```C#
        // TODO: 18 - Send all telemetry to local blob storage
        // var blockBlob = _blobContainer.GetBlockBlobReference($"telemetry_{info.timestamp.Ticks}.json");
        // blockBlob.UploadText(serializedString);
    ```

7. Save your changes.

8. In VS Code, open **module.json**, in the repository property, change the URI to **LOGIN SERVER/vehicletelemetrysimulator**, replacing the login server value with your container registry login server value. The login server takes the form of **[container repository name].azurecr.io**.

    ![In the JSON editor the image repository property is highlighted showing the repository for the compiled image.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image199.png 'Image Repository property')

9. Sign in to Docker by entering the following command in the VS Code integrated terminal, using the Container Registry credentials and server information:

    ```Bash
    docker login -u <username>    -p <password>    <Login server>
    ```

10. To build the project, right-click the **module.json** file in the Explorer and select **Build IoT Edge Module Image**.

    ![The module.json file is right-clicked and the Build IoT Edge Module Image item is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image267.png 'Build IoT Edge module')

11. Select **amd64** as the platform of choice. This will create a Linux-based Docker image.

    ![amd64 is selected as the platform.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image91.png 'Select Platform')

12. To push the image to the Azure Container Registry, right-click the **module.json** file and select **Build and Push IoT Edge Module Image**.

    ![The module.json file is right-clicked and the Build and Push IoT Edge Module Image item is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image89.png 'Build and push IoT Edge module')

13. Once again, select **amd64** as the platform of choice. This will create a Linux-based Docker image.

    ![amd64 is selected as the platform.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image91.png 'Select Platform')

14. Watch the VS Code terminal window. You should see a success status when the build is complete. **Take note of the tag applied to your vehicle-telemetry-simulator image**. You will need to use this tag when you add the module to your IoT Edge device via the portal later on.

    ![In a terminal window, next to "Successfully tagged," the tag is value is highlighted.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image92.png 'VS Code terminal window showing a successful build')

### Task 4: Create the Azure Stream Analytics IoT Edge module

In this task, you will create a Stream Analytics job that filters vehicle telemetry data generated by the custom C\# module, and outputs only the most important data to potentially two different outputs in IoT Hub.

1. Navigate to the Azure Portal, ```http://portal.azure.com```.

2. Select **+ Create a resource**, then type **stream analytics** into the search box on top. Select **Stream Analytics job** from the results.

    ![The search field in the Azure Portal is set to stream analytics.Stream Analytics job item is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image96.png 'Add stream analytics job')

3. Select the **Create** button on the Stream Analytics job overview blade.

4. On the New Stream Analytics job blade, specify the following configuration options:

    a. **Name**: Unique value for the Job name (ensure the green check mark appears).

    b. Specify your **Resource Group**, ensuring it's the same one in which your new components have been created.

    c. Select the same **location** as your Resource Group and other services. Please note: Currently, Azure Stream Analytics jobs on IoT Edge aren't supported in the West US 2 region.

    d. Select the **Edge** hosting environment.

    ![In the New Stream Analytics job form fields are set to the previously defined settings.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image97.png 'New Stream Analytics job blade')

5. Select **Create**.

6. In the created job, under **Job Topology**, select **Inputs**, and then select **+ Add stream input**, then select **Edge Hub**.

    ![The Add stream input button is highlighted, then the Edge Hub item is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image98.png 'Inputs blade')

7. Provide the following configuration in the New input blade:

    a. **Input alias**: VehicleTelemetry

    b. **Event-serialization format**: JSON

    c. **Encoding**: UTF-8

    d. **Compression**: None

    ![The input form is displayed with the previous values populated.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image99.png 'Edge Hub new input')

8. Select **Save**.

9. Under **Job Topology**, select **Outputs**, and then select **+ Add**, then select **Edge Hub**.

10. Provide the following configuration in the New output blade:

    a. **Input alias**: Alert

    b. **Event-serialization format**: JSON

    c. **Encoding**: UTF-8

    ![The new output form is displayed populated with the previous values.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image100.png 'Edge Hub new output')

11. Select **Save**.

12. Select **+ Add** under **Outputs** to create a new output that will trigger the route you created in IoT Hub earlier, that sends events filtered on the EngineAlert output, to the custom endpoint and on to the Service Bus Queue.

13. Provide the following configuration in the New output blade:

    a. **Input alias**: EngineAlert

    b. **Event-serialization format**: JSON

    c. **Encoding**: UTF-8

    ![Enter EngineAlert for the Output alias.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image101.png 'Edge Hub new output')

14. Select **Save**.
  
15. From the left-hand Stream Analytics menu, select the **Query** item from the Job Topology section. You will see the input and three outputs that you created. Select **Edit query** to the right of the displayed Query container.

    ![The Query menu item is selected from the left hand menu. The Edit query button is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image102.png 'Stream Analytics overview blade')

16. Create a step that averages the engine temperature and speed over a two second duration. Create another step that selects all telemetry data, including the average values from the previous step, and specifies the following anomalies as new fields:

    a. **enginetempanomaly**: When the average engine temperature is \>= 405 or \<= 15.

    b. **oilanomaly**: When the engine oil \<= 1.

    c. **aggressivedriving**: When the transmission gear position is in first, second, or third, and the brake pedal status is 1, the accelerator pedal position \>= 90, and the average speed is \>= 55.

17. Have the query output all fields from the anomalies step into the Alert output where aggressivedriving = 1 or enginetempanomaly = 1.

18. Have the query output all fields from the anomalies step where the enginetempanomaly = 1 and oilanomaly = 1.

19. Have the query output all fields from all the data into a "sink" that records all data.

20. Here is the completed query:

    ```sql
    WITH
    Averages AS (
    select
        AVG(engineTemperature) averageEngineTemperature,
        AVG(speed) averageSpeed
    FROM
        VehicleTelemetry TIMESTAMP BY [timestamp]
    GROUP BY
        TumblingWindow(Duration(second, 2))
    ),
    Anomalies AS (
    select
        t.vin,
        t.[timestamp],
        t.outsideTemperature,
        t.engineTemperature,
        a.averageEngineTemperature,
        t.speed,
        a.averageSpeed,
        t.fuel,
        t.engineoil,
        t.tirepressure,
        t.odometer,
        t.accelerator_pedal_position,
        t.parking_brake_status,
        t.headlamp_status,
        t.brake_pedal_status,
        t.transmission_gear_position,
        t.ignition_status,
        t.windshield_wiper_status,
        t.abs,
        t.mlDetectedAggressiveDriving,
        (case when a.averageEngineTemperature >= 405 OR a.averageEngineTemperature <= 15 then 1 else 0 end) as enginetempanomaly,
        (case when t.engineoil <= 1 then 1 else 0 end) as oilanomaly,
        (case when (t.transmission_gear_position = 'first' OR
            t.transmission_gear_position = 'second' OR
            t.transmission_gear_position = 'third') AND
            t.brake_pedal_status = 1 AND
            t.accelerator_pedal_position >= 90 AND
            a.averageSpeed >= 55 OR t.mlDetectedAggressiveDriving = 1 then 1 else 0 end)  as aggressivedriving
    from VehicleTelemetry t TIMESTAMP BY [timestamp]
    INNER JOIN Averages a ON DATEDIFF(second, t, a) BETWEEN 0 And 2
    )
    SELECT
        *
    INTO
        Alert
    FROM
        Anomalies
    where aggressivedriving = 1 OR enginetempanomaly = 1
    SELECT
        *
    INTO
        EngineAlert
    FROM
        Anomalies
    where enginetempanomaly = 1 AND oilanomaly = 1

    ```

21. To test the query with sample data, press the **Upload sample input** button in the bottom-right panel toolbar.

    ![The edit query form is displayed, beneath the query textbox, the Upload sample input button is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image103.png 'Upload sample input')

22. Use the browse button to select the **sample-vehicle-telemetry.json** file extracted to the Lab-files folder from the starter solution zip file you downloaded. This file contains 1000 JSON records of simulated vehicle telemetry.

    ![In the Upload input data blade, the browse button is highlighted and the sample-vehicle-telemetry.json file is displayed in the textbox.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image104.png 'Select sample input file')

23. Select **OK**.

24. Select **Test query** in the toolbar above the query.

    ![In the Query blade, the Test query button is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image105.png 'Test the analytics query with the sample data')

25. In the Outputs list, ensure Alert is selected. The test results should display that there are 85 rows.

    ![In the Results section a list of data is displayed, at the top of the list it shows a label indicating it is showing 85 rows form alert.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image106.png 'Test Results section')

26. **Save** the query.

### Task 5: Deploy custom modules to IoT Edge device

In this task, you will deploy the vehicle telemetry module, Stream Analytics module, and an IoT Edge Storage module to the IoT Edge device. All will be deployed simultaneously so you can register the module routes to send vehicle telemetry data to the Stream Analytics module, then send the filtered data upstream to IoT Hub as needed. The Vehicle Telemetry module will also send all telemetry data into IoT Edge Storage. The IoT Edge Storage module is responsible for synchronizing this data to a storage account in the cloud. The IoT Edge Storage module is intelligent, it can be configured to delete local blocks of data that have already been moved to the cloud, as well as recover from connection interruptions. IoT Edge Storage is ideal for a sometimes connected scenario, data will be held locally until a feasible internet connection is available to upload to the cloud.

1. Open your **IoT Hub**.

2. Select **IoT Edge** from the left-hand menu, then select your IoT Edge device to open the details page.

    ![In the IoT Hub, under Explorers, IoT Edge is selected. Under IoT Edge Devices, bus1 is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image107.png 'IoT Hub')

3. Select **Set Modules**.

    ![Set Modules button is selected in the Device Details menu.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image108.png 'Device Details blade')

4. In the **Container Registry Settings** add an entry with your container registry name, username and password.

    ![The IoT Edge Container Registry connection information form is displayed in the set modules screen. The container name, address, user name and password fields are highlighted and populated with values.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image204.png 'Container Registry connection information')

5. From the **IoT Edge Modules** section Select **Add** and choose **IoT Edge Module**.

    ![The Add button is selected, and the IoT Edge Module item is chosen in the Device Details blade.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image109.png 'Device Details blade')

6. Enter the following configuration values in the IoT Edge Module form:

    a. **Name**: VehicleTelemetry

    b. **Image URI**: The image URI path you specified when you created the Docker image and registered it in Azure Container Registry. Should be in the form of **\<your container registry address\>/vehicle-telemetry-simulator:0.0.1-amd64** (the tag should be the same as defined when your docker image was created in VS Code).

    c. **Restart Policy**: always

    d. **Desired Status**: running

    ![The add module form is displayed populated with the previous values](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image110.png 'IoT Edge Module blade')

7. Select **Add**.

8. From the **IoT Edge Modules** section Select **Add** and choose **Azure Stream Analytics Module**.

    ![The Add button is selected, and the Azure Stream Analytics module item highlighted in the IoT Edge Modules section.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image111.png 'Device Details blade')

9. Select your Azure subscription, then the Stream Analytics job you created in the previous task.

10. If you are missing a storage account setting, select the link to set it up.

    ![A message is displayed indicating the Edge job you have selected is missing Storage account settings, please set them up here. The here word is a link that is selected.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image205.png "Missing Storage Account")

11. Once the Stream Analytics Job Storage Account Settings blade is opened, press the **Add storage account** button.

    a. **Storage Account Settings**: choose **Select storage account from your subscriptions**.

    b. **Subscription**: select your desired subscription.

    c. **Storage account**: select the storage account in which you created the **asa-container** blob earlier.

    d. **Container**: select **Use existing**, then select **asa-container**

    ![The Stream analytics job form is displayed with the fields set to the previously defined settings.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image112.png 'Edge deployment blade')

12. Select **Save**, then close the tab that was added to your browser to select the storage account.

13. Return to the Stream Analytics - Edge job blade, and press **Save**, this will publish the module.

14. Once published, copy the name of your Stream Analytics module.

    ![iot-edge-sa is highlighted in the deployment modules list.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image113.png 'Deployment modules list')

15. From the **IoT Edge Modules** section Select **Add** and choose **Marketplace Module**.

    ![The add button is selected, and the Marketplace Module item is highlighted in the IoT Edge Modules section.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image269.png)

16. In the IoT Edge Module Marketplace, search for **Azure Blob Storage on IoT Edge** and select the module with the same name.

    ![In the IoT Edge Module Marketplace blade, the search term Azure Blob Storage on IoT Edge is entered and the module with the same name is selected in the search results.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image270.png)

17. The AzureBlobStorageonIoTEdge has now been added to the IoT Edge modules list. Select the AzureBlobStorageonIoTEdge item in this list so that we can provide it with the desired configuration.
  
    ![The AzureBlobStorageonIoTEdge module is selected in the list of IoT Edge Modules.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image271.png)

18. Once the Update IoT Edge Module blade has been opened, select the **Environment Variables** tab, and enter the following values:

    | Name | Value |
    |------|-------|
    | LOCAL_STORAGE_ACCOUNT_NAME | edgestorage |
    | LOCAL_STORAGE_ACCOUNT_KEY  | pM8cWFj0L8h+VKRfE8Fy3tVVtdfOR4bCIzX8N/sDiK1X0znhu8iatFwVfjzwjedDKe5ln+2cI7wpy+2eO1vvQQ== |

    ![The Update IoT Edge Module screen is displayed and the Environment Variables tab is selected. In textboxes the environment variables referenced in the previous table are displayed.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image275.png)

19. Next, select the **Container Create Options** tab, enter the following - then select **Update**:

    ```javascript
    {
        "HostConfig":{
            "Binds": [
                "/storage/containerdata:/blobroot"
            ],
            "PortBindings": {
                "11002/tcp": [
                    {
                        "HostPort": "11002"
                    }
                ]
            }
        }
    }
    ```

    ![The Update IoT Edge Module blade is shown with the Container Create Options tab selected with a textbox populated with the JSON based configuration above.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image272.png)

20. In the same Update IoT Edge Module blade, select the **Module Twin Settings** tab.
    - Desired properties textbox - remember to replace the **cloudStorageConnectionString** value with your own:

        ```javascript
        {
            "deviceAutoDeleteProperties": {
                "deleteOn": false,
                "retainWhileUploading": true
            },
            "deviceToCloudUploadProperties": {
                "uploadOn": true,
                "uploadOrder": "OldestFirst",
                "cloudStorageConnectionString": "<Storage Account Connection String>",
                "storageContainersForUpload": {
                    "telemetry": {
                        "target": "telemetrysink"
                    }
                }
            },
            "deleteAfterUpload": true
        }
        ```

        ![The Update IoT Edge Module blade is shown with the Module Twin Settings tab selected with a textbox populated with the JSON based configuration above.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image274.png)

21. Press **Update**.

22. Select **Next: Routes >** underneath the IoT Edge modules list.

23. In the **Routes** table add the following. Replace _{moduleName}_ with the Stream Analytics module name that you copied):

    | Name | Value |
    |------|---------|
    | alertsToCloud | FROM /messages/modules/{moduleName}/outputs/* INTO $upstream |
    | telemetryToAsa | FROM /messages/modules/VehicleTelemetry/outputs/* INTO BrokeredEndpoint("/modules/{moduleName}/inputs/VehicleTelemetry") |

    ![The routes are displayed for the bus1 modules as specified in the previous table above.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image114.png 'Set Modules, Routes page')

24. Select **Review + Create**.

25. In the Review screen, select **Create**.

26. After approximately 4 minutes, return to the device details page. You should see the three new modules running, along with the IoT Edge agent module and the IoT Edge hub.

    ![On the Deployed Modules tab, under Name, iot-edge-sa, azureblobstorageoniotedge, and VehicleTelemetry modules are called out.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image115.png 'Device Details page Deployed Modules tab')

27. Go back to your Bash shell that is connected to the Linux VM containing your IoT Edge device.

28. Execute the following to make sure all the modules are running in Docker:

    ```Bash
    sudo iotedge list
    ```

    ![Bash window displays the list of docker images running in the IoT Edge simulator VM.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image116.png 'Bash shell')

29. You should have five containers running at this point.

30. View the Stream Analytics module logs to see the telemetry it is reading, as well as any outputs it generates based on anomalies. You should see a large degree more vehicle telemetry feeding into the Stream Analytics module than what it sends out. This, of course, is by design. Replace {moduleName} with the Stream Analytics module name. Press <kbd>Ctrl/Cmd</kbd>+<kbd>c</kbd> to return to the command line.

    ```Bash
    sudo iotedge logs -f {moduleName}
    ```

    ![In the Output window, results from the Stream Analytics module logs display.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image206.png 'Output window')

31. View the generated data by viewing the log for the VehicleTelemetry module as follows. Press <kbd>Ctrl/Cmd</kbd>+<kbd>c</kbd> to return to the command line.

    ```Bash
    sudo iotedge logs -f VehicleTelemetry
    ```

32. Notice the log output as shown below. There are many "Sending message: \[VehicleTelemetry\]" events, and one output generated (highlighted). The output name is **alert**, matching one of the two outputs we created in the Stream Analytics module. The message content is sent to IoT Hub, including the additional fields added by the Stream Analytics query. In this case, the telemetry data is flagged as aggressive driving (aggressivedriving: 1).

    ![In the Bash window, results from the Vehicle Telemetry module logs display.](images/Hands-onlabstep-by-step-IoTandtheSmartCityimages/media/image207.png 'Bash window')

33. Leave the IoT Edge device running for the remainder of the lab.
